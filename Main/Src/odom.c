/* 
################
    Odometry
################
*/

#include"odom.h"

float pos_x=0,pos_y=0;
uint32_t chase_phase = 0;

void CalcPosition(){
    float rad = deg *(M_PI / 180.);
    float spd_ms = spd * 1000.;
    pos_x+=spd_ms*DELTA_T*-sin(rad);
    pos_y+=spd_ms*DELTA_T*cos(rad);
}

float traject[][3]={{0.0000000000,0.0000000000,0.0000000000},
{1.0000000000,0.0000008397,0.0000033588},
{1.9999999997,0.0000134079,0.0000268546},
{2.9999999985,0.0000679628,0.0000906123},
{3.9999999734,0.0002147870,0.0002146653},
{4.9999978427,0.0005240710,0.0004189152},
{5.9999940292,0.0010859132,0.0007231311},
{6.9999905170,0.0020082394,0.0011465832},
{7.9999882820,0.0034209190,0.0017086556},
{8.9999872924,0.0054750013,0.0024288363},
{9.9999865077,0.0083390077,0.0033261415},
{10.9999838799,0.0121989319,0.0044191159},
{11.9999763525,0.0172582400,0.0057258329},
{12.9999598610,0.0237378701,0.0072638941},
{13.9999293329,0.0318762330,0.0090504297},
{14.9998786876,0.0419292115,0.0111020983},
{15.9998008362,0.0541701608,0.0134350869},
{16.9996876820,0.0688899084,0.0160651111},
{17.9995301200,0.0863953912,0.0190074149},
{18.9993141823,0.1069951809,0.0222767708},
{19.9990130216,0.1310293330,0.0258874797},
{20.9986123071,0.1588539644,0.0298532220},
{21.9980919825,0.1908340272,0.0341863064},
{22.9974239411,0.2273433085,0.0388988969},
{23.9965720257,0.2687644307,0.0440024886},
{24.9954920281,0.3154888514,0.0495077690},
{25.9941316897,0.3679168633,0.0554246175},
{26.9924307012,0.4264575941,0.0617621062},
{27.9903207027,0.4915290068,0.0685284991},
{28.9877252835,0.5635578997,0.0757312526},
{29.9845599824,0.6429799059,0.0833770154},
{30.9807322876,0.7302394939,0.0914716284},
{31.9761416366,0.8257899674,0.1000201249},
{32.9706793465,0.9300746837,0.1090267303},
{33.9642129674,1.0435268060,0.1184948623},
{34.9565965653,1.1666119802,0.1284271309},
{35.9476781234,1.2997892378,0.1388252402},
{36.9372897836,1.4435100265,0.1496898381},
{37.9252478459,1.5982182097,0.1610207165},
{38.9113527690,1.7643500673,0.1728168303},
{39.8953891701,1.9423342946,0.1850762970},
{40.8771258246,2.1325920035,0.1977963967},
{41.8563156665,2.3355367216,0.2109735727},
{42.8326957882,2.5515743924,0.2246034306},
{43.8059874406,2.7811033758,0.2386807391},
{44.7758960330,3.0245144474,0.2531994295},
{45.7421111332,3.2821907990,0.2681525960},
{46.7043064674,3.5545050150,0.2835324953},
{47.6621441128,3.8417784457,0.2993305473},
{48.6152769749,4.1443379048,0.3155373342},
{49.5633191408,4.4624985062,0.3321427227},
{50.5058737668,4.7965499723,0.3491362827},
{51.4425360656,5.1467566344,0.3665061874},
{52.3728933057,5.5133574322,0.3842399263},
{53.2965248117,5.8965659147,0.4023244402},
{54.2130019646,6.2965702390,0.4207461210},
{55.1218882010,6.7135331715,0.4394908118},
{56.0227390139,7.1475920869,0.4585438069},
{56.9151019524,7.5988589688,0.4778898517},
{57.7985166215,8.0674204097,0.4975131428},
{58.6725146824,8.5533376104,0.5173973280},
{59.5366198524,9.0566463809,0.5375255062},
{60.3903481308,9.5773550441,0.5578802276},
{61.2332527314,10.1154291829,0.5784434933},
{62.0648757715,10.6708002381,0.5991967560},
{62.8847393292,11.2433737227,0.6201217752},
{63.6923813732,11.8330292714,0.6411998975},
{64.4873557630,12.4396206403,0.6624115049},
{65.2692322484,13.0629757071,0.6837369276},
{66.0375964699,13.7028964712,0.7051564435},
{66.7920499586,14.3591590532,0.7266502786},
{67.5322101362,15.0315136956,0.7481986067},
{68.2577103148,15.7196847622,0.7697815499},
{68.9681996974,16.4233707386,0.7913791780},
{69.6633433772,17.1422442317,0.8129715087},
{70.3428223383,17.8759519700,0.8345385080},
{71.0063334552,18.6241184408,0.8560600895},
{71.6535972921,19.3863885418,0.8775161150},
{72.2843906738,20.1623521432,0.8988863941},
{72.8985002952,20.9515768986,0.9201509094},
{73.4957383015,21.7536264038,0.9412908298},
{74.0759457867,22.5680601971,0.9622865951},
{74.6389927931,23.3944337587,0.9831188866},
{75.1847783115,24.2322985113,1.0037688502},
{75.7132302813,25.0812018198,1.0242180965},
{76.2243055903,25.9406869914,1.0444487004},
{76.7179900748,26.8102932755,1.0644432013},
{77.1942985197,27.6895558638,1.0841846033},
{77.6532746584,28.5780058904,1.1036563748},
{78.0949911725,29.4751704314,1.1228424489},
{78.5195496925,30.3805725053,1.1417272231},
{78.9270806919,31.2937533950,1.1602955595},
{79.3177258725,32.2142874658,1.1785327847},
{79.6916687846,33.1417279314,1.1964246899},
{80.0491300085,34.0756413981,1.2139581640},
{80.3903479680,35.0156088682,1.2311208942},
{80.7155789301,35.9612257394,1.2479008201},
{81.0250970053,36.9121018052,1.2642866863},
{81.3191941476,37.8678612548,1.2802680417},
{81.5981801542,38.8281426733,1.2958352403},
{81.8623826657,39.7925990412,1.3109794406},
{82.1121471662,40.7608977348,1.3256926057},
{82.3478369831,41.7327205262,1.3399675036},
{82.5698332873,42.7077635832,1.3537977069},
{82.7785350928,43.6857374691,1.3671775928},
{82.9743592573,44.6663670412,1.3801023433},
{83.1577297529,45.6493953116,1.3925679451},
{83.3290463563,46.6345912645,1.4045711895},
{83.4887526516,47.6217388770,1.4161096919},
{83.6372970446,48.6106352263,1.4271821060},
{83.7751269565,49.6010904898,1.4377880266},
{83.9026888242,50.5929279450,1.4479278829},
{84.0204280998,51.5859839699,1.4576029437},
{84.1287892510,52.5801080422,1.4668153168},
{84.2282157607,53.5751627402,1.4755679497},
{84.3191501275,54.5710237422,1.4838646288},
{84.4020338653,55.5675798267,1.4917099801},
{84.4773075035,56.5647328725,1.4991094690},
{84.5454105869,57.5623978583,1.5060693999},
{84.6067816757,58.5605028633,1.5125969168},
{84.6618582171,59.5589786990,1.5187000030},
{84.7110488826,60.5577558554,1.5243874809},
{84.7547560981,61.5567885284,1.5296690124},
{84.7933870980,62.5560353124,1.5345546388},
{84.8273350680,63.5554586938,1.5390553135},
{84.8569791453,64.5550250512,1.5431831125},
{84.8826844182,65.5547046556,1.5469506669},
{84.9048019267,66.5544716698,1.5503711631},
{84.9236686620,67.5543041491,1.5534583429},
{84.9396075666,68.5541840406,1.5562265031},
{84.9529275344,69.5540971839,1.5586904961},
{84.9639234109,70.5540333107,1.5608657292},
{84.9728759925,71.5539860446,1.5627681653},
{84.9800520275,72.5539529016,1.5644143222},
{84.9857042152,73.5539346231,1.5658212732},
{84.9900681148,74.5539244006,1.5670066468},
{84.9933495723,75.5539183224,1.5679886268},
{84.9957430765,76.5539151885,1.5687858284},
{84.9974250373,77.5539139870,1.5694165975},
{84.9985523702,78.5539138941,1.5698999365},
{84.9992624966,79.5539142741,1.5702551301},
{84.9996733433,80.5539146795,1.5705016365},
{84.9998833432,81.5539148509,1.5706590872},
{84.9999714346,82.5539147167,1.5707472868},
{84.9999970615,83.5539143939,1.5707862136},
{85.0000001739,84.5539141872,1.5707960190},
{85.0000000000,84.9999997369,1.5707963268}};

void GenerateChase(){
    chase_phase++;
    if(chase_phase >= 140){
        runmode = DISABLE_MODE;
        return;
    }

    float tgt_x = traject[chase_phase][0];
    float tgt_y = traject[chase_phase][1];
    float tgt_rad = traject[chase_phase][2];

    float rad = deg *(M_PI / 180.);
    float cos_rad = cos(rad),sin_rad = sin(rad);

    float err_x = (tgt_x - pos_x)*cos_rad+(tgt_y - pos_y)*sin_rad;
    float err_y = -(tgt_x - pos_x)*sin_rad+(tgt_y - pos_y)*cos_rad;
    float err_theta = rad - tgt_rad;

    float Vr = 0.1;
    float Wr = 0.1;

    tgt_spd = Vr*cos(err_theta) + KX*err_x;
    tgt_angvel = Wr + Vr*(KY*err_y + KT*sin(err_theta));
}